<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Markdown rendering library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for security -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    
    <title>Markdownåº“éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .markdown-content {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
        .markdown-content h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        .markdown-content h2 {
            color: #34495e;
            border-bottom: 1px solid #bdc3c7;
            padding-bottom: 3px;
        }
        .markdown-content h3 {
            color: #34495e;
        }
        .markdown-content strong {
            color: #2c3e50;
            font-weight: bold;
        }
        .markdown-content em {
            color: #7f8c8d;
            font-style: italic;
        }
        .markdown-content code {
            background-color: #f8f9fa;
            color: #e83e8c;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        .markdown-content pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .markdown-content blockquote {
            border-left: 4px solid #3498db;
            margin: 10px 0;
            padding-left: 15px;
            color: #7f8c8d;
            font-style: italic;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        .markdown-content th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .markdown-content ul, .markdown-content ol {
            padding-left: 20px;
        }
        .markdown-content li {
            margin: 5px 0;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .raw-markdown {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Markdownåº“éªŒè¯æµ‹è¯•</h1>
        
        <div id="libraryStatus" class="status">æ­£åœ¨æ£€æŸ¥åº“åŠ è½½çŠ¶æ€...</div>
        
        <div class="test-section">
            <h2>ğŸ“ åŸºç¡€Markdownæµ‹è¯•</h2>
            <button onclick="testBasicMarkdown()">æµ‹è¯•åŸºç¡€Markdown</button>
            <div id="basicTest" class="markdown-content">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•åŸºç¡€Markdownæ¸²æŸ“...
            </div>
            <details>
                <summary>æŸ¥çœ‹åŸå§‹Markdown</summary>
                <div id="basicRaw" class="raw-markdown"></div>
            </details>
        </div>
        
        <div class="test-section">
            <h2>ğŸŒ APIæ•°æ®æµ‹è¯•</h2>
            <button onclick="testAPIData()">æµ‹è¯•APIæ•°æ®æ¸²æŸ“</button>
            <div id="apiTest" class="markdown-content">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•APIæ•°æ®æ¸²æŸ“...
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”§ å¤æ‚æ ¼å¼æµ‹è¯•</h2>
            <button onclick="testComplexMarkdown()">æµ‹è¯•å¤æ‚æ ¼å¼</button>
            <div id="complexTest" class="markdown-content">
                ç‚¹å‡»æŒ‰é’®æµ‹è¯•å¤æ‚æ ¼å¼æ¸²æŸ“...
            </div>
            <details>
                <summary>æŸ¥çœ‹åŸå§‹Markdown</summary>
                <div id="complexRaw" class="raw-markdown"></div>
            </details>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            <div id="testResults">
                ç­‰å¾…æµ‹è¯•...
            </div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥åº“æ˜¯å¦æ­£ç¡®åŠ è½½
        function checkLibraries() {
            const status = document.getElementById('libraryStatus');
            
            if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                status.innerHTML = 'âœ… marked.js å’Œ DOMPurify åº“åŠ è½½æˆåŠŸï¼';
                status.className = 'status success';
                
                // æ˜¾ç¤ºåº“ç‰ˆæœ¬ä¿¡æ¯
                const results = document.getElementById('testResults');
                results.innerHTML = `
                    <div class="success">
                        <h3>åº“åŠ è½½æˆåŠŸ</h3>
                        <p><strong>marked.jsç‰ˆæœ¬:</strong> ${marked.version || 'æœªçŸ¥'}</p>
                        <p><strong>DOMPurifyç‰ˆæœ¬:</strong> ${DOMPurify.version || 'æœªçŸ¥'}</p>
                        <p><strong>æµ‹è¯•æ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                `;
            } else {
                status.innerHTML = 'âŒ åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                status.className = 'status error';
                
                const results = document.getElementById('testResults');
                results.innerHTML = `
                    <div class="error">
                        <h3>åº“åŠ è½½å¤±è´¥</h3>
                        <p><strong>marked.jsçŠ¶æ€:</strong> ${typeof marked}</p>
                        <p><strong>DOMPurifyçŠ¶æ€:</strong> ${typeof DOMPurify}</p>
                        <p>è¯·æ£€æŸ¥CDNé“¾æ¥å’Œç½‘ç»œè¿æ¥ã€‚</p>
                    </div>
                `;
            }
        }
        
        // Markdown parser using marked.js library
        function enhancedMarkdownParse(text) {
            if (!text) return '';
            
            // Configure marked options for better compatibility
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false,
                sanitize: false,
                smartLists: true,
                smartypants: true
            });
            
            // Parse markdown and sanitize HTML
            const rawHtml = marked.parse(text);
            const cleanHtml = DOMPurify.sanitize(rawHtml);
            
            return cleanHtml;
        }
        
        // æµ‹è¯•åŸºç¡€markdown
        function testBasicMarkdown() {
            const testElement = document.getElementById('basicTest');
            const rawElement = document.getElementById('basicRaw');
            
            const markdownText = `# ä¸€çº§æ ‡é¢˜

## äºŒçº§æ ‡é¢˜

### ä¸‰çº§æ ‡é¢˜

è¿™æ˜¯ä¸€ä¸ª**ç²—ä½“æ–‡æœ¬**å’Œ*æ–œä½“æ–‡æœ¬*çš„ç¤ºä¾‹ã€‚

è¿™æ˜¯ä¸€ä¸ªè¡Œå†…ä»£ç ï¼š\`console.log('Hello World')\`

> è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨æ–‡æœ¬çš„ç¤ºä¾‹ã€‚

- æ— åºåˆ—è¡¨é¡¹1
- æ— åºåˆ—è¡¨é¡¹2
- æ— åºåˆ—è¡¨é¡¹3

1. æœ‰åºåˆ—è¡¨é¡¹1
2. æœ‰åºåˆ—è¡¨é¡¹2
3. æœ‰åºåˆ—è¡¨é¡¹3

è¿™æ˜¯ä¸€ä¸ª[é“¾æ¥ç¤ºä¾‹](https://www.example.com)ã€‚`;

            rawElement.textContent = markdownText;
            const parsedHtml = enhancedMarkdownParse(markdownText);
            testElement.innerHTML = parsedHtml;
            
            console.log('åŸºç¡€Markdownæµ‹è¯•å®Œæˆ');
        }
        
        // æµ‹è¯•APIæ•°æ®
        async function testAPIData() {
            const testElement = document.getElementById('apiTest');
            testElement.innerHTML = 'æ­£åœ¨åŠ è½½APIæ•°æ®...';
            
            try {
                const response = await fetch('http://localhost:8080/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stock_code: '000001',
                        enable_ai: false
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const aiAnalysis = result.data.ai_analysis;
                    const parsedHtml = enhancedMarkdownParse(aiAnalysis);
                    testElement.innerHTML = parsedHtml;
                    
                    console.log('APIæ•°æ®æµ‹è¯•å®Œæˆ');
                } else {
                    testElement.innerHTML = `<p style="color: red;">APIè°ƒç”¨å¤±è´¥: ${result.error}</p>`;
                }
            } catch (error) {
                testElement.innerHTML = `<p style="color: red;">è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æµ‹è¯•å¤æ‚æ ¼å¼
        function testComplexMarkdown() {
            const testElement = document.getElementById('complexTest');
            const rawElement = document.getElementById('complexRaw');
            
            const markdownText = `# å¤æ‚æ ¼å¼æµ‹è¯•

## è¡¨æ ¼æµ‹è¯•

| åˆ—1 | åˆ—2 | åˆ—3 |
|-----|-----|-----|
| æ•°æ®1 | æ•°æ®2 | æ•°æ®3 |
| æ•°æ®4 | æ•°æ®5 | æ•°æ®6 |
| æ•°æ®7 | æ•°æ®8 | æ•°æ®9 |

## ä»£ç å—æµ‹è¯•

\`\`\`javascript
function calculateRSI(prices, period = 14) {
    let gains = 0;
    let losses = 0;
    
    for (let i = 1; i < prices.length; i++) {
        const change = prices[i] - prices[i - 1];
        if (change > 0) {
            gains += change;
        } else {
            losses += Math.abs(change);
        }
    }
    
    const avgGain = gains / period;
    const avgLoss = losses / period;
    const rs = avgGain / avgLoss;
    
    return 100 - (100 / (1 + rs));
}
\`\`\`

## æ··åˆæ ¼å¼æµ‹è¯•

è¿™æ˜¯ä¸€ä¸ªåŒ…å«**ç²—ä½“**ã€*æ–œä½“*ã€\`è¡Œå†…ä»£ç \`å’Œ[é“¾æ¥](https://example.com)çš„æ®µè½ã€‚

### åµŒå¥—åˆ—è¡¨æµ‹è¯•

1. ä¸€çº§åˆ—è¡¨é¡¹1
   - äºŒçº§åˆ—è¡¨é¡¹1
   - äºŒçº§åˆ—è¡¨é¡¹2
2. ä¸€çº§åˆ—è¡¨é¡¹2
   - äºŒçº§åˆ—è¡¨é¡¹3
   - äºŒçº§åˆ—è¡¨é¡¹4

> å¼•ç”¨ä¸­çš„**ç²—ä½“æ–‡æœ¬**
> 
> > åµŒå¥—å¼•ç”¨ä¸­çš„*æ–œä½“æ–‡æœ¬*

## æ•°å­¦å…¬å¼æµ‹è¯•

ç®€å•çš„æ•°å­¦å…¬å¼ï¼šE = mcÂ²

## æ°´å¹³çº¿æµ‹è¯•

---

ä»¥ä¸Šå°±æ˜¯å¤æ‚æ ¼å¼çš„æµ‹è¯•å†…å®¹ã€‚`;

            rawElement.textContent = markdownText;
            const parsedHtml = enhancedMarkdownParse(markdownText);
            testElement.innerHTML = parsedHtml;
            
            console.log('å¤æ‚æ ¼å¼æµ‹è¯•å®Œæˆ');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥åº“çŠ¶æ€
        window.addEventListener('load', checkLibraries);
    </script>
</body>
</html>